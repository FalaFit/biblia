<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente B√≠blico - DEBUG MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Open+Sans:wght@400;600;700&display=swap');
        
        body { 
            font-family: 'Open Sans', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Merriweather', serif;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in { 
            animation: fadeIn 0.6s ease-out; 
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .animate-shake { 
            animation: shake 0.5s; 
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 30px rgba(234, 179, 8, 0.4); }
            50% { box-shadow: 0 0 50px rgba(234, 179, 8, 0.6); }
        }
        
        .glow-animation { 
            animation: glow 3s ease-in-out infinite; 
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .float-animation { 
            animation: float 3s ease-in-out infinite; 
        }

        .gradient-text {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hidden { display: none; }

        /* Formata√ß√£o da resposta */
        #respostaTexto {
            line-height: 1.8;
        }

        #respostaTexto p {
            margin-bottom: 1.25rem;
        }

        #respostaTexto blockquote {
            border-left: 4px solid #fbbf24;
            padding-left: 1.25rem;
            margin: 1.5rem 0;
            font-style: italic;
            color: #fef3c7;
            background: rgba(251, 191, 36, 0.05);
            padding: 1rem 1.25rem;
            border-radius: 0.5rem;
        }

        #respostaTexto strong {
            color: #fbbf24;
            font-weight: 600;
        }

        #respostaTexto ul, #respostaTexto ol {
            margin: 1.25rem 0;
            padding-left: 1.75rem;
        }

        #respostaTexto li {
            margin-bottom: 0.75rem;
        }

        #respostaTexto hr {
            border: none;
            border-top: 2px solid rgba(251, 191, 36, 0.2);
            margin: 2.5rem 0;
        }

        /* Refer√™ncias b√≠blicas CLIC√ÅVEIS */
        .verse-ref {
            display: inline-block;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.25) 0%, rgba(245, 158, 11, 0.25) 100%);
            border: 2px solid rgba(251, 191, 36, 0.6);
            padding: 4px 12px;
            border-radius: 10px;
            font-weight: 700;
            color: #fbbf24;
            font-size: 0.95em;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.3);
            position: relative;
        }

        .verse-ref::before {
            content: "üìñ";
            margin-right: 6px;
            font-size: 0.9em;
        }

        .verse-ref:hover {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.4) 0%, rgba(245, 158, 11, 0.4) 100%);
            border-color: #fbbf24;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.5);
        }

        .verse-ref::after {
            content: "Clique para ver contexto";
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: rgba(0, 0, 0, 0.9);
            color: #fbbf24;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75em;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .verse-ref:hover::after {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }

        .verse-ref-plain {
            color: #fbbf24;
            font-weight: 600;
        }

        /* Modal de vers√≠culo */
        .verse-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(12px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .verse-modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 3px solid rgba(251, 191, 36, 0.4);
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.9);
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .verse-modal.show .verse-modal-content {
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* üÜï PAINEL DE DEBUG */
        .debug-panel {
            background: #0f172a;
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #fbbf24;
            max-height: 400px;
            overflow-y: auto;
        }

        .debug-title {
            color: #ef4444;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .debug-ok {
            color: #10b981;
        }

        .debug-warn {
            color: #f59e0b;
        }

        .debug-error {
            color: #ef4444;
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 10px;
            border: 2px solid #1e293b;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    
    <!-- APLICA√á√ÉO PRINCIPAL (Login removido para debug) -->
    <div id="mainApp" class="min-h-screen">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-amber-600/10 via-amber-500/10 to-amber-600/10 backdrop-blur-sm border-b border-amber-500/20 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <div class="w-14 h-14 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center glow-animation shadow-2xl">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                            </div>
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-slate-900 animate-pulse" title="DEBUG MODE"></div>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold gradient-text">Assistente B√≠blico - DEBUG MODE</h1>
                            <p class="text-sm text-red-400">üîç Modo diagn√≥stico ativado</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto px-6 py-8">
            
            <!-- Input de Pergunta -->
            <div class="bg-gradient-to-br from-slate-800/50 to-slate-700/30 backdrop-blur-xl rounded-3xl border-2 border-amber-500/20 p-8 mb-8 shadow-2xl animate-fade-in">
                <label class="block text-lg font-semibold text-amber-100 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Fa√ßa sua pergunta sobre a B√≠blia:
                </label>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <textarea 
                        id="perguntaInput" 
                        placeholder="Ex: Quem foi Mois√©s?" 
                        class="flex-1 bg-slate-900/70 text-white placeholder-slate-500 rounded-2xl border-2 border-slate-600 focus:border-amber-500 px-6 py-4 focus:outline-none focus:ring-2 focus:ring-amber-500/50 resize-none transition-all shadow-inner"
                        rows="3"
                    >Quem foi Mois√©s?</textarea>
                    
                    <button 
                        id="consultarButton" 
                        class="bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed text-white px-8 py-4 rounded-2xl transition-all duration-300 flex items-center justify-center gap-3 font-bold text-lg shadow-2xl hover:shadow-amber-500/50 transform hover:scale-105 disabled:transform-none"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Consultar
                    </button>
                </div>
            </div>

            <!-- üÜï PAINEL DE DEBUG -->
            <div id="debugPanel" class="hidden debug-panel">
                <div class="debug-title">üîç DEBUG: An√°lise das Fontes</div>
                <div id="debugContent"></div>
            </div>

            <!-- Error Area -->
            <div id="errorArea" class="hidden bg-red-900/20 border-2 border-red-500/50 rounded-2xl p-6 mb-8 animate-fade-in">
                <div class="flex items-start gap-4">
                    <svg class="w-6 h-6 text-red-400 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="text-red-300 font-semibold text-lg mb-1">Ops! Algo deu errado</p>
                        <p id="errorMessage" class="text-red-200/80"></p>
                    </div>
                </div>
            </div>

            <!-- Loading Area -->
            <div id="loadingArea" class="hidden bg-gradient-to-br from-slate-800/50 to-slate-700/30 backdrop-blur-xl rounded-3xl border-2 border-amber-500/20 p-12 text-center animate-fade-in shadow-2xl">
                <div class="relative inline-block mb-6">
                    <svg class="animate-spin h-16 w-16 text-amber-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="text-white text-xl font-semibold mb-2">Consultando as Escrituras...</p>
                <p class="text-slate-400">Buscando os vers√≠culos mais relevantes</p>
            </div>

            <!-- Resposta Area -->
            <div id="respostaArea" class="hidden bg-gradient-to-br from-slate-800/50 to-slate-700/30 backdrop-blur-xl rounded-3xl border-2 border-amber-500/30 overflow-hidden shadow-2xl animate-fade-in">
                <div class="bg-gradient-to-r from-green-600/20 via-green-500/20 to-green-600/20 border-b border-green-500/30 px-8 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-green-300 font-bold text-lg">Resposta Encontrada</p>
                            <p class="text-green-200/70 text-sm">Fundamentada nas Escrituras Sagradas</p>
                        </div>
                    </div>
                    <button id="novaConsultaBtn" class="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 border border-amber-500/40 text-amber-200 rounded-lg transition-all text-sm font-medium">
                        Nova Consulta
                    </button>
                </div>

                <div class="p-8">
                    <div id="respostaTexto" class="text-slate-100 text-lg prose prose-invert max-w-none"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL DE VERS√çCULO -->
    <div id="verseModal" class="verse-modal hidden">
        <div class="verse-modal-content">
            <div class="bg-gradient-to-r from-amber-600 via-amber-500 to-amber-600 p-6 flex items-center justify-between">
                <div class="flex-1">
                    <h3 id="verseModalTitle" class="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        Vers√≠culo B√≠blico
                    </h3>
                    <p id="verseModalSubtitle" class="text-amber-100 text-sm"></p>
                </div>
                <button id="closeVerseBtn" class="bg-white/20 hover:bg-white/30 text-white p-3 rounded-xl transition-all flex-shrink-0 ml-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="p-8">
                <div id="verseModalContent" class="text-slate-100 text-lg leading-relaxed"></div>
            </div>

            <div class="bg-slate-900/50 px-8 py-4 text-center border-t border-amber-500/20">
                <p class="text-sm text-slate-400">üìñ Clique fora ou pressione ESC para fechar</p>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            webhookUrl: 'https://planejamentocomercialtvx.app.n8n.cloud/webhook/biblia-query'
        };

        let fontesGlobal = [];

        const perguntaInput = document.getElementById('perguntaInput');
        const consultarButton = document.getElementById('consultarButton');
        const errorArea = document.getElementById('errorArea');
        const errorMessage = document.getElementById('errorMessage');
        const loadingArea = document.getElementById('loadingArea');
        const respostaArea = document.getElementById('respostaArea');
        const respostaTexto = document.getElementById('respostaTexto');
        const novaConsultaBtn = document.getElementById('novaConsultaBtn');
        const debugPanel = document.getElementById('debugPanel');
        const debugContent = document.getElementById('debugContent');

        const verseModal = document.getElementById('verseModal');
        const verseModalTitle = document.getElementById('verseModalTitle');
        const verseModalSubtitle = document.getElementById('verseModalSubtitle');
        const verseModalContent = document.getElementById('verseModalContent');
        const closeVerseBtn = document.getElementById('closeVerseBtn');

        // üÜï FUN√á√ÉO DE DEBUG DETALHADA
        function mostrarDebugFontes(fontes) {
            let html = '<div style="margin-bottom: 12px;">Total de fontes: <span class="debug-ok">' + fontes.length + '</span></div>';
            
            fontes.forEach((fonte, idx) => {
                const temContexto = fonte.texto_contexto && fonte.texto_contexto.length > 0;
                const tamanhoTexto = fonte.texto?.length || 0;
                const tamanhoContexto = fonte.texto_contexto?.length || 0;
                const isContextoMaior = tamanhoContexto > tamanhoTexto;
                
                html += '<div style="margin: 8px 0; padding: 8px; background: #1e293b; border-left: 3px solid ' + (isContextoMaior ? '#10b981' : '#ef4444') + ';">';
                html += '<div style="font-weight: bold; margin-bottom: 4px;">Fonte #' + idx + ': ' + (fonte.referencia || 'N/A') + '</div>';
                html += '<div>‚Ä¢ Livro: <span class="debug-ok">' + (fonte.livro || 'N/A') + '</span></div>';
                html += '<div>‚Ä¢ Cap: ' + (fonte.capitulo || 'N/A') + ' | Vers: ' + (fonte.versiculo_inicio || fonte.versiculo || 'N/A');
                if (fonte.versiculo_fim && fonte.versiculo_fim !== fonte.versiculo_inicio) {
                    html += '-' + fonte.versiculo_fim;
                }
                html += ' | Trad: ' + (fonte.traducao || 'N/A') + '</div>';
                html += '<div>‚Ä¢ <span class="debug-warn">texto</span>: ' + tamanhoTexto + ' chars</div>';
                html += '<div>‚Ä¢ <span class="' + (temContexto ? 'debug-ok' : 'debug-error') + '">texto_contexto</span>: ';
                
                if (temContexto) {
                    html += tamanhoContexto + ' chars ';
                    if (isContextoMaior) {
                        html += '<span class="debug-ok">‚úì MAIOR</span>';
                    } else {
                        html += '<span class="debug-warn">‚ö† IGUAL AO TEXTO</span>';
                    }
                } else {
                    html += '<span class="debug-error">‚ùå AUSENTE</span>';
                }
                html += '</div>';
                
                if (temContexto && tamanhoContexto > 0) {
                    html += '<div style="margin-top: 4px; font-size: 10px; color: #64748b;">Preview: ' + 
                            (fonte.texto_contexto.substring(0, 100) + '...') + '</div>';
                }
                
                html += '</div>';
            });
            
            const fontesComContextoCompleto = fontes.filter(f => 
                f.texto_contexto && f.texto_contexto.length > (f.texto?.length || 0) * 1.2
            );
            const percentual = (fontesComContextoCompleto.length / fontes.length * 100).toFixed(1);
            
            html += '<div style="margin-top: 16px; padding: 12px; background: #1e293b; border: 2px solid ' + 
                    (parseFloat(percentual) >= 80 ? '#10b981' : '#ef4444') + ';">';
            html += '<div class="debug-title">üìä Resumo:</div>';
            html += '<div>Fontes com contexto expandido: <span class="' + 
                    (parseFloat(percentual) >= 80 ? 'debug-ok' : 'debug-error') + '">' + 
                    fontesComContextoCompleto.length + '/' + fontes.length + ' (' + percentual + '%)</span></div>';
            
            if (parseFloat(percentual) < 80) {
                html += '<div class="debug-error" style="margin-top: 8px;">‚ö†Ô∏è PROBLEMA: Menos de 80% das fontes t√™m contexto completo!</div>';
                html += '<div class="debug-error">‚Üí Verifique se o c√≥digo do Build Context foi aplicado no n8n</div>';
            } else {
                html += '<div class="debug-ok" style="margin-top: 8px;">‚úÖ OK: Contexto completo presente na maioria das fontes</div>';
            }
            html += '</div>';
            
            debugContent.innerHTML = html;
            debugPanel.classList.remove('hidden');
        }

        function limparFormatacaoProblematica(html) {
            html = html.replace(/<strong>(\d+)\.<\/strong>\s*\n/g, '$1.\n');
            html = html.replace(/<strong>(\d+)\.<\/strong>\s*/g, '$1. ');
            html = html.replace(/<strong>\*\*(\d+)\.<\/strong>/g, '$1.');
            return html;
        }

        function encontrarFonteFlexivel(livro, capitulo, versiculo, traducao, fontes) {
            console.log(`üîç Buscando: ${livro} ${capitulo}:${versiculo} (${traducao})`);
            
            const livroNormalizado = livro.toLowerCase().trim();
            
            for (let i = 0; i < fontes.length; i++) {
                const fonte = fontes[i];
                const livroFonteNormalizado = (fonte.livro || '').toLowerCase().trim();
                
                if (
                    livroFonteNormalizado === livroNormalizado &&
                    fonte.capitulo === capitulo &&
                    fonte.traducao === traducao
                ) {
                    const versInicio = fonte.versiculo_inicio || fonte.versiculo;
                    const versFim = fonte.versiculo_fim || fonte.versiculo;
                    
                    if (versiculo >= versInicio && versiculo <= versFim) {
                        console.log(`   ‚úÖ ENCONTRADO! Fonte #${i}: ${fonte.referencia}`);
                        console.log(`   Range: ${versInicio}-${versFim}, buscado: ${versiculo}`);
                        return { fonte, indice: i };
                    }
                }
            }
            
            console.warn(`   ‚ö†Ô∏è N√ÉO ENCONTRADO nas ${fontes.length} fontes`);
            return null;
        }

        function openVerseModal(indice) {
            console.log('');
            console.log('üìñ ===== ABRINDO MODAL =====');
            console.log('√çndice da fonte:', indice);
            
            const fonte = fontesGlobal[indice];
            
            if (!fonte) {
                console.error('‚ùå Fonte n√£o encontrada no √≠ndice', indice);
                return;
            }
            
            console.log('Fonte encontrada:', fonte.referencia);
            console.log('Campos dispon√≠veis:', Object.keys(fonte));
            console.log('texto:', fonte.texto?.length || 0, 'chars');
            console.log('texto_contexto:', fonte.texto_contexto?.length || 0, 'chars');
            
            verseModalTitle.textContent = fonte.referencia;
            verseModalSubtitle.textContent = `${fonte.traducao} ‚Ä¢ Contexto completo do cap√≠tulo`;
            
            // üÜï PRIORIZA texto_contexto, com fallback
            const textoContexto = fonte.texto_contexto || fonte.texto || '';
            
            console.log('Texto final usado:', textoContexto.length, 'chars');
            console.log('Preview:', textoContexto.substring(0, 100) + '...');
            console.log('============================');
            console.log('');
            
            let textoFormatado = textoContexto
                .replace(/\n\n+/g, '</p><p class="mb-4 text-slate-100">')
                .replace(/\n/g, '<br>');
            
            if (!textoFormatado.includes('<p')) {
                textoFormatado = `<p class="mb-4 text-slate-100">${textoFormatado}</p>`;
            }
            
            verseModalContent.innerHTML = `
                <div class="verse-context">
                    <div class="bg-amber-500/10 border-2 border-amber-500/30 rounded-xl p-4 mb-6">
                        <p class="font-bold mb-2 text-amber-100">üìñ Contexto B√≠blico</p>
                        <p class="text-sm text-amber-300/90">
                            <strong>${fonte.referencia}</strong> com vers√≠culos adjacentes
                        </p>
                    </div>
                    
                    <div class="verse-text bg-slate-900/60 rounded-xl p-6 border-2 border-amber-500/20">
                        <blockquote class="border-l-4 border-amber-500 pl-6 italic leading-relaxed text-slate-50">
                            ${textoFormatado}
                        </blockquote>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-slate-700/50 text-xs text-slate-400">
                        <div>üìä Caracteres: ${textoContexto.length}</div>
                        <div class="${textoContexto.length > 200 ? 'debug-ok' : 'debug-error'}">
                            ${textoContexto.length > 200 ? '‚úÖ Contexto completo' : '‚ö†Ô∏è Contexto incompleto (esperado ~800 chars)'}
                        </div>
                    </div>
                </div>
            `;
            
            verseModal.classList.remove('hidden');
            verseModal.classList.add('show');
        }

        function closeVerseModal() {
            verseModal.classList.add('hidden');
            verseModal.classList.remove('show');
        }

        closeVerseBtn.addEventListener('click', closeVerseModal);
        verseModal.addEventListener('click', (e) => {
            if (e.target === verseModal) closeVerseModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !verseModal.classList.contains('hidden')) {
                closeVerseModal();
            }
        });

        consultarButton.addEventListener('click', fazerPergunta);
        
        perguntaInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                fazerPergunta();
            }
        });

        novaConsultaBtn.addEventListener('click', () => {
            respostaArea.classList.add('hidden');
            debugPanel.classList.add('hidden');
            perguntaInput.value = '';
            perguntaInput.focus();
            fontesGlobal = [];
        });

        async function fazerPergunta() {
            const pergunta = perguntaInput.value.trim();
            
            if (!pergunta) {
                perguntaInput.focus();
                return;
            }

            consultarButton.disabled = true;
            consultarButton.innerHTML = '<svg class="animate-spin h-6 w-6" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Consultando...';
            
            errorArea.classList.add('hidden');
            respostaArea.classList.add('hidden');
            debugPanel.classList.add('hidden');
            loadingArea.classList.remove('hidden');

            try {
                const response = await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pergunta: pergunta })
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üîç ===== DEBUG COMPLETO =====');
                console.log('üì¶ Resposta completa:', data);
                console.log('üìä Fontes:', data.fontes);
                console.log('============================');
                
                let respostaTextoFinal = data.resposta || data.message?.content || '';
                const fontes = data.fontes || [];
                
                fontesGlobal = fontes;
                
                // üÜï MOSTRA DEBUG DAS FONTES
                mostrarDebugFontes(fontes);
                
                console.log(`‚úÖ Total de fontes recebidas: ${fontes.length}`);
                
                let countSubstituicoes = 0;
                
                respostaTextoFinal = respostaTextoFinal.replace(
                    /\*\*\(([^)]+)\)\*\*/g,
                    (match, ref) => {
                        countSubstituicoes++;
                        console.log(`üîç [${countSubstituicoes}] Processando: "${ref}"`);
                        
                        const refParts = ref.match(/^(.+?)\s+(\d+):(\d+(?:-\d+)?)\s*-\s*(NVI|ACF|AA)$/);
                        
                        if (!refParts) {
                            console.warn(`‚ö†Ô∏è Formato n√£o reconhecido: "${ref}"`);
                            return `<span class="verse-ref-plain">${ref}</span>`;
                        }
                        
                        const [_, livro, cap, vers, trad] = refParts;
                        const versiculoNumero = parseInt(vers.split('-')[0]);
                        
                        console.log(`   üìñ Buscando: ${livro} ${cap}:${versiculoNumero} (${trad})`);
                        
                        const resultado = encontrarFonteFlexivel(livro, parseInt(cap), versiculoNumero, trad, fontes);
                        
                        if (resultado) {
                            console.log(`   ‚úÖ ENCONTRADO! √çndice: ${resultado.indice}`);
                            return `<span class="verse-ref" data-indice="${resultado.indice}">${ref}</span>`;
                        } else {
                            console.warn(`   ‚ö†Ô∏è N√ÉO ENCONTRADO`);
                            return `<span class="verse-ref-plain">${ref}</span>`;
                        }
                    }
                );
                
                console.log(`üéØ Total de substitui√ß√µes: ${countSubstituicoes}`);
                
                let htmlContent = marked.parse(respostaTextoFinal);
                htmlContent = limparFormatacaoProblematica(htmlContent);
                
                respostaTexto.innerHTML = htmlContent;
                
                const verseRefs = respostaTexto.querySelectorAll('.verse-ref');
                console.log(`üñ±Ô∏è Total de .verse-ref encontrados: ${verseRefs.length}`);
                
                verseRefs.forEach((ref, idx) => {
                    const indice = parseInt(ref.dataset.indice);
                    console.log(`   [${idx+1}] Adicionando click - √≠ndice: ${indice}`);
                    
                    ref.addEventListener('click', () => {
                        console.log(`üñ±Ô∏è CLIQUE! Abrindo modal com √≠ndice: ${indice}`);
                        openVerseModal(indice);
                    });
                });

                loadingArea.classList.add('hidden');
                respostaArea.classList.remove('hidden');
                
                setTimeout(() => {
                    respostaArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
                
            } catch (err) {
                console.error('‚ùå ERRO:', err);
                
                loadingArea.classList.add('hidden');
                errorArea.classList.remove('hidden');
                errorMessage.textContent = err.message || 'Erro ao conectar com o servidor.';
            } finally {
                consultarButton.disabled = false;
                consultarButton.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Consultar';
            }
        }

        // Auto-executa a pergunta ao carregar
        setTimeout(() => fazerPergunta(), 500);
    </script>
</body>
</html>
